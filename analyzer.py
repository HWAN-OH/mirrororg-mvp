# analyzer.py
# ì—­í• : íŒŒì‹±ëœ ë°ì´í„°ë¥¼ ë°›ì•„ LLM APIì™€ í†µì‹ í•˜ê³ , í•˜ë‚˜ì˜ ì™„ì„±ëœ 'ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ'ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
# ìµœì¢… ë²„ì „: 'ë°ì´í„° ìƒì„±'ì—ì„œ 'ë³´ê³ ì„œ ìž‘ì„±'ìœ¼ë¡œ íŒ¨ëŸ¬ë‹¤ìž„ì„ ì „í™˜í•˜ì—¬ ì•ˆì •ì„±ê³¼ ê²°ê³¼ë¬¼ì˜ ê°€ì¹˜ë¥¼ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.

import google.generativeai as genai
import pandas as pd

# --- [Lumina & Delta] The Ultimate Report Generation Prompt ---

PROMPT_COMPREHENSIVE_REPORT = """
### íŽ˜ë¥´ì†Œë‚˜ ë° ë¯¸ì…˜ (Persona & Mission)
ë‹¹ì‹ ì€ 'ë¯¸ëŸ¬ì˜¤ì•Œì§€(MirrorOrg)' í”„ë ˆìž„ì›Œí¬ë¥¼ ì‹¤í–‰í•˜ëŠ” ìµœê³  ìˆ˜ì¤€ì˜ AI ì¡°ì§ ë¶„ì„ê°€ìž…ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ìœ ì¼í•œ ìž„ë¬´ëŠ” ì£¼ì–´ì§„ íŒ€ì˜ ì±„íŒ… ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬, íŒ€ì˜ ë¶•ê´´ë¥¼ ë§‰ê³  ì„±ìž¥ì„ ë•ê¸° ìœ„í•œ **'ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ'**ë¥¼ ìž‘ì„±í•˜ëŠ” ê²ƒìž…ë‹ˆë‹¤.
ë³´ê³ ì„œëŠ” ë°˜ë“œì‹œ 'ë¯¸ëŸ¬ì˜¤ì•Œì§€'ì˜ í•µì‹¬ ë°©ë²•ë¡ ê³¼ 'í”„ë¡œì íŠ¸ ì—ì½”' ë¶„ì„ ì‚¬ë¡€ë¥¼ ì°¸ê³ í•˜ì—¬, ì•„ëž˜ ì§€ì •ëœ Markdown í˜•ì‹ì— ë”°ë¼ ìž‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

### í”„ë ˆìž„ì›Œí¬ í•µì‹¬ ì§€ì‹: ë¯¸ëŸ¬ì˜¤ì•Œì§€(MirrorOrg) ë°©ë²•ë¡ 

**1. ì •ì˜ (Definition):**
'ë¯¸ëŸ¬ì˜¤ì•Œì§€(MirrorOrg)'ëŠ” ì¸ê°„ ì¡°ì§ì„ 'ë³µìž¡ê³„'ë¡œ ë³´ê³ , ì •ì„±ì ì¸ ëŒ€í™”ë¥¼ ì •ëŸ‰ì ì¸ ë°ì´í„°ì™€ í†µì°°ë ¥ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì‹œìŠ¤í…œì˜ ìˆ¨ê²¨ì§„ ì—­í•™ì„ ì§„ë‹¨í•˜ê³  ì˜ˆì¸¡í•˜ëŠ” í”„ë ˆìž„ì›Œí¬ìž…ë‹ˆë‹¤.

**2. í”„ë¡œì„¸ìŠ¤ (Process): ì§„ë‹¨ â†’ ì˜ˆì¸¡**
* **ì§„ë‹¨ (Diagnosis):** íŒ€ì˜ í˜„ìž¬ ìƒíƒœë¥¼ ë°ì´í„°ë¡œ ê°ê´€í™”í•©ë‹ˆë‹¤. (ì˜ˆ: íŒ€ í”„ë¡œí•„ ë¶„ì„)
* **ì˜ˆì¸¡ (Prediction):** ì§„ë‹¨ëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¯¸ëž˜ì˜ ë¦¬ìŠ¤í¬ë¥¼ ì˜ˆì¸¡í•©ë‹ˆë‹¤. (ì˜ˆ: í”¼ë¡œë„ ë³€í™”, ê´€ê³„ ë„¤íŠ¸ì›Œí¬ ë¶„ì„)

**3. ì‚¬ê³  ê³¼ì • (Chain of Thought):**
* **1ë‹¨ê³„ (íŒ¨í„´ ì¸ì‹):** ì±„íŒ… ê¸°ë¡ì—ì„œ 'í”„ë¡œì íŠ¸ ì—ì½”' ì‚¬ë¡€ì™€ ìœ ì‚¬í•œ íŒ¨í„´ì„ ì°¾ìŠµë‹ˆë‹¤. (ì˜ˆ: íŠ¹ì •ì¸ì˜ ì „ëžµì  ë°œì–¸, ë‹¤ë¥¸ ì´ì˜ ê°ì •ì  í˜¸ì†Œ, ì˜ê²¬ ì¶©ëŒ ë“±)
* **2ë‹¨ê³„ (ì§€ì‹ ì—°ê²°):** ì¸ì‹ëœ íŒ¨í„´ì„ 'ë¯¸ëŸ¬ì˜¤ì•Œì§€'ì˜ ê°œë…(ì •ì²´ì„± ê³„ìˆ˜, ì •ì„œì  ë¶€ì±„, êµ¬ì¡°ì  ê¸´ìž¥ ë“±)ê³¼ ì—°ê²°í•˜ì—¬ í•´ì„í•©ë‹ˆë‹¤.
* **3ë‹¨ê³„ (ë³´ê³ ì„œ ìž‘ì„±):** í•´ì„ëœ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ, ì•„ëž˜ì˜ ë³´ê³ ì„œ í˜•ì‹ì— ë§žì¶° ê° ì„¹ì…˜ì„ ì±„ì›Œë‚˜ê°‘ë‹ˆë‹¤.

---
### ìµœì¢… ë³´ê³ ì„œ ì¶œë ¥ í˜•ì‹ (Markdown)

# MirrorOrg ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ

## 1. ë¶„ì„ ê°œìš”
* **ë¶„ì„ ê¸°ê°„:** [ì±„íŒ… ê¸°ë¡ì˜ ì‹œìž‘ ë‚ ì§œ] ~ [ì±„íŒ… ê¸°ë¡ì˜ ë§ˆì§€ë§‰ ë‚ ì§œ]
* **ë¶„ì„ ëŒ€ìƒ:** [ì±„íŒ… ê¸°ë¡ì— ì°¸ì—¬í•œ ì£¼ìš” ì¸ë¬¼ ëª©ë¡]
* **í•µì‹¬ ìš”ì•½:** (ë¶„ì„ ê²°ê³¼ì— ëŒ€í•œ 2~3 ë¬¸ìž¥ì˜ í•µì‹¬ ìš”ì•½)

---

## 2. Phase 1: ì§„ë‹¨ (Diagnosis)
### 2.1. ì •ì²´ì„± ê³„ìˆ˜ ë§µ (Identity Coefficient Map)
íŒ€ì›ë“¤ì˜ ì„±í–¥ê³¼ ì—­í• ì„ íŒŒì•…í•˜ì—¬ íŒ€ì˜ ì „ì²´ì ì¸ êµ¬ì„±ì„ ì§„ë‹¨í•©ë‹ˆë‹¤.

| ì´ë¦„ (ê°€ëª…) | ê°ì • | ì‚¬ê³  | í‘œí˜„ | ê°€ì¹˜ | íŽ¸í–¥ | í•µì‹¬ ì—­í•  |
| :--- | :---: | :---: | :---: | :---: | :---: | :--- |
| (ì˜ˆ: Julian) | âš–ï¸ 5 | ðŸ§  9 | âœï¸ 6 | â­ 9 | ðŸŽ¯ 7 | The Driver (ì „ëžµ ì¤‘ì‹¬) |
| (ì°¸ì—¬ìž A) | (ì ìˆ˜) | (ì ìˆ˜) | (ì ìˆ˜) | (ì ìˆ˜) | (ì ìˆ˜) | (ì—­í• ) |
| (ì°¸ì—¬ìž B) | (ì ìˆ˜) | (ì ìˆ˜) | (ì ìˆ˜) | (ì ìˆ˜) | (ì ìˆ˜) | (ì—­í• ) |

**ë¶„ì„ ê·¼ê±°:**
* **[ì°¸ì—¬ìž A ì´ë¦„]:** (í•´ë‹¹ ì°¸ì—¬ìžì˜ ê³„ìˆ˜ê°€ ì™œ ê·¸ë ‡ê²Œ íŒë‹¨ë˜ì—ˆëŠ”ì§€, ì±„íŒ… ë‚´ìš©ì˜ êµ¬ì²´ì ì¸ ì˜ˆì‹œë¥¼ ë“¤ì–´ 1~2 ë¬¸ìž¥ìœ¼ë¡œ ì„œìˆ )
* **[ì°¸ì—¬ìž B ì´ë¦„]:** (ë¶„ì„ ê·¼ê±° ì„œìˆ )

---

## 3. Phase 2: ì˜ˆì¸¡ (Prediction)
### 3.1. í”¼ë¡œë„ ë³€í™” (Fatigue Trajectory)
ì‹œê°„ì— ë”°ë¥¸ íŒ€ì›ë“¤ì˜ ê°ì •ì , ì—…ë¬´ì  ì†Œì§„ ìƒíƒœì˜ ë³€í™”ë¥¼ ì˜ˆì¸¡í•©ë‹ˆë‹¤.

* **ì£¼ìš” ê´€ì°° ì‚¬í•­:** (ì˜ˆ: í”„ë¡œì íŠ¸ ë§ˆê°ì¼ì´ ìž„ë°•í•œ Xì›” ë§, íŠ¹ì • íŒ€ì›(ë“¤)ì˜ í”¼ë¡œë„ê°€ ê¸‰ì¦í•˜ëŠ” íŒ¨í„´ì´ ê´€ì°°ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” 'ì •ì„œì  ë¶€ì±„'ê°€ ëˆ„ì ë˜ê³  ìžˆìŒì„ ì‹œì‚¬í•©ë‹ˆë‹¤.)
* **ë¦¬ìŠ¤í¬ ë¶„ì„:** (ì˜ˆ: ì´ëŸ¬í•œ í”¼ë¡œë„ ì¦ê°€ëŠ” íŒ€ì˜ ë²ˆì•„ì›ƒ ë¦¬ìŠ¤í¬ë¥¼ ë†’ì´ë©°, íŠ¹ížˆ ê°ì • ê³„ìˆ˜ê°€ ë†’ì€ íŒ€ì›ì—ê²Œ ë¶€ë‹´ì´ ì§‘ì¤‘ë  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.)

### 3.2. ê´€ê³„ ë„¤íŠ¸ì›Œí¬ (Relationship Network)
íŒ€ì› ê°„ ìƒí˜¸ìž‘ìš©ì˜ ì§ˆì„ ë¶„ì„í•˜ì—¬ ìž ìž¬ì  ê°ˆë“± ë° í˜‘ë ¥ ê´€ê³„ë¥¼ ì˜ˆì¸¡í•©ë‹ˆë‹¤.

* **ì£¼ìš” ê´€ì°° ì‚¬í•­:** (ì˜ˆ: ë¦¬ë”ì¸ Aì˜ ê²°ê³¼ ì¤‘ì‹¬ì  ì†Œí†µê³¼, íŒ€ì› Bì˜ ìƒíƒœ í‘œí˜„ ì¤‘ì‹¬ì  ì†Œí†µ ì‚¬ì´ì— ë°˜ë³µì ì¸ ì˜ê²¬ ì¶©ëŒì´ ê´€ì°°ë˜ì—ˆìŠµë‹ˆë‹¤.)
* **ë¦¬ìŠ¤í¬ ë¶„ì„:** (ì˜ˆ: ì´ëŠ” ê°œì¸ì˜ ë¬¸ì œê°€ ì•„ë‹Œ, ì—­í• ê³¼ ì†Œí†µ ë°©ì‹ì˜ ì°¨ì´ì—ì„œ ì˜¤ëŠ” 'êµ¬ì¡°ì  ê¸´ìž¥'ìž…ë‹ˆë‹¤. ì´ ê¸´ìž¥ì„ ì¤‘ìž¬í•  ë©”ì»¤ë‹ˆì¦˜ì´ ì—†ë‹¤ë©´, ìž ìž¬ì  ê°ˆë“±ìœ¼ë¡œ ë°œì „í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.)

---

## 4. ì¢…í•© ê²°ë¡  ë° ì œì–¸
(ë¶„ì„ ë‚´ìš©ì„ ì¢…í•©í•˜ì—¬, ì´ íŒ€ì˜ ê°€ìž¥ í° ì‹œìŠ¤í…œì  ê°•ì ê³¼ ë¦¬ìŠ¤í¬ëŠ” ë¬´ì—‡ì¸ì§€ 2~3 ë¬¸ìž¥ìœ¼ë¡œ ìš”ì•½í•˜ê³ , ê°œì„ ì„ ìœ„í•œ ê°„ë‹¨í•œ ì œì–¸ì„ ë§ë¶™ìž…ë‹ˆë‹¤.)

---
### [ë¶„ì„ ëŒ€ìƒ ì±„íŒ… ê¸°ë¡]
{chat_log}
---
### [ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ (Markdown í˜•ì‹)]
"""

def call_gemini_api(prompt: str, chat_log: str) -> str | None:
    """
    Calls the Gemini API and returns the raw text response.
    """
    try:
        model = genai.GenerativeModel('gemini-1.5-flash')
        safety_settings = [{"category": f"HARM_CATEGORY_{cat}", "threshold": "BLOCK_NONE"} for cat in ["HARASSMENT", "HATE_SPEECH", "SEXUALLY_EXPLICIT", "DANGEROUS_CONTENT"]]
        
        full_prompt = prompt.format(chat_log=chat_log)
        response = model.generate_content(full_prompt, safety_settings=safety_settings)

        if not response.parts:
            return "## ë¶„ì„ ì‹¤íŒ¨\n\nAPIê°€ ì‘ë‹µ ìƒì„±ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤. ìž…ë ¥ ë°ì´í„°ì— ë¯¼ê°í•œ ë‚´ìš©ì´ í¬í•¨ë˜ì—ˆì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤."

        return response.text
    except Exception as e:
        return f"## ë¶„ì„ ì‹¤íŒ¨\n\nAPI í˜¸ì¶œ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n\n```\n{str(e)}\n```"

def generate_report(chat_df: pd.DataFrame) -> str | None:
    """
    Generates a single comprehensive report from the chat data.
    """
    # Include date information in the log for better temporal analysis
    chat_log = "\n".join(chat_df.apply(lambda row: f"{row['date']}: [{row['speaker']}] {row['message']}", axis=1))
    return call_gemini_api(PROMPT_COMPREHENSIVE_REPORT, chat_log)
