import streamlit as st
import re
from analyzer import analyze_report

# --- UI ì„¤ì • (í˜ì´ì§€ ë° ì‚¬ì´ë“œë°”) ---
st.set_page_config(page_title="MirrorOrg MVP", layout="centered")

# ì‚¬ì´ë“œë°” êµ¬ì„±
with st.sidebar:
    # ì–¸ì–´ ì„ íƒ (ê¸°ëŠ¥ì€ ìœ ì§€í•˜ë˜, í˜„ì¬ëŠ” í”„ë¡¬í”„íŠ¸ì— ì§ì ‘ì ì¸ ì˜í–¥ì€ ì—†ìŒ)
    lang_option = st.radio("Language", ["í•œêµ­ì–´", "English"])
    
    st.info("#### ğŸ’¡ **How to Use**\n1. Upload your team's chat log (e.g., KakaoTalk .txt file).\n2. Click the 'Analyze' button.\n3. Receive a 1-page diagnostic report generated by AI.")
    
    st.warning(
        "#### âš ï¸ **Disclaimer**\n"
        "This is a technology demonstrator. The analysis is for reference only and should not be used for personnel evaluation. All uploaded data is processed in memory and not stored."
    )
    
    st.markdown("---")
    st.markdown("Â© 2025 MirrorMind, Inc. All Rights Reserved.")


# --- ë©”ì¸ í™”ë©´ êµ¬ì„± ---
st.title("ğŸ§  MirrorOrg ì¡°ì§ ì§„ë‹¨ ë¦¬í¬íŠ¸")
st.markdown("AI ì¡°ì§ ì‹¬ë¦¬ ë¶„ì„ê°€ê°€ ëŒ€í™” ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ íŒ€ì˜ ì†Œí†µ íŒ¨í„´ê³¼ ì‹œìŠ¤í…œ ë¦¬ìŠ¤í¬ë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤.")

# íŒŒì¼ ì—…ë¡œë”
uploaded_file = st.file_uploader(
    "ë¶„ì„í•  ëŒ€í™” íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. (ì¹´ì¹´ì˜¤í†¡ .txt íŒŒì¼ ê¶Œì¥)", 
    type="txt"
)

# ë¶„ì„ ì‹¤í–‰ ë²„íŠ¼
analyze_button = st.button("ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„±í•˜ê¸°", type="primary")

# --- ë¶„ì„ ë¡œì§ ì‹¤í–‰ ---
if analyze_button and uploaded_file:
    with st.spinner("AIê°€ ëŒ€í™” ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."):
        try:
            # íŒŒì¼ ë‚´ìš© ì½ê¸° ë° ì „ì²˜ë¦¬
            chat_content = uploaded_file.read().decode("utf-8")
            
            # ë„ˆë¬´ ê¸´ ëŒ€í™”ëŠ” ìµœì‹  3000ì¤„ë¡œ ì œí•œí•˜ì—¬ API ë¹„ìš© ë° ì‹œê°„ ê´€ë¦¬
            lines = chat_content.split('\n')
            if len(lines) > 3000:
                chat_content = '\n'.join(lines[-3000:])
                st.toast("ëŒ€í™” ë‚´ìš©ì´ ë„ˆë¬´ ê¸¸ì–´ ìµœì‹  3000ì¤„ë§Œ ë¶„ì„í•©ë‹ˆë‹¤.")

            # ë¶„ì„ ëª¨ë“ˆ í˜¸ì¶œ
            report = analyze_report(chat_content)

            # ê²°ê³¼ ì¶œë ¥
            if report:
                st.markdown("---")
                st.success("âœ… AI ì¡°ì§ ì§„ë‹¨ ë¦¬í¬íŠ¸ê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
                st.markdown(report)
            else:
                st.error("ë¦¬í¬íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ ë‚´ìš©ì´ ë„ˆë¬´ ì§§ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ í˜•ì‹ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

        except Exception as e:
            st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

elif analyze_button and not uploaded_file:
    st.warning("ë¶„ì„ì„ ìœ„í•´ ë¨¼ì € ëŒ€í™” íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
