import streamlit as st
from analyzer import analyze_report

# --- ë‹¤êµ­ì–´ í…ìŠ¤íŠ¸ ê´€ë¦¬ ---
# UIì— ì‚¬ìš©ë  ëª¨ë“  í…ìŠ¤íŠ¸ë¥¼ ì–¸ì–´ë³„ë¡œ ì •ì˜í•©ë‹ˆë‹¤.
TRANSLATIONS = {
    "ko": {
        "page_title": "MirrorOrg ì¡°ì§ ì§„ë‹¨",
        "lang_selector_label": "Language / ì–¸ì–´",
        "sidebar_info_header": "ğŸ’¡ **ì‚¬ìš© ë°©ë²•**",
        "sidebar_info_text": "1. íŒ€ì˜ ëŒ€í™” ê¸°ë¡ íŒŒì¼(ì˜ˆ: ì¹´ì¹´ì˜¤í†¡/whatsapp .txt)ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.\n2. 'ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„±í•˜ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.\n3. AIê°€ ìƒì„±í•œ 1í˜ì´ì§€ ì§„ë‹¨ ë¦¬í¬íŠ¸ë¥¼ ë°›ì•„ë³´ì„¸ìš”.",
        "sidebar_warn_header": "âš ï¸ **ë©´ì±… ì¡°í•­**",
        "sidebar_warn_text": "ë³¸ ì„œë¹„ìŠ¤ëŠ” ê¸°ìˆ  ì‹œì—°ìš© MVPì…ë‹ˆë‹¤. ë¶„ì„ ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©°, ì¸ì‚¬ í‰ê°€ì˜ ê·¼ê±°ë¡œ ì‚¬ìš©ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì—…ë¡œë“œëœ ë°ì´í„°ëŠ” ë©”ëª¨ë¦¬ì—ì„œë§Œ ì²˜ë¦¬ë˜ë©° ì„œë²„ì— ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
        "sidebar_copyright": "Â© 2025 Sunghwan Oh. All Rights Reserved.",
        "main_title": "ğŸ§  MirrorOrg ì¡°ì§ ì§„ë‹¨ ë¦¬í¬íŠ¸",
        "main_subtitle": "AI ì¡°ì§ ì‹¬ë¦¬ ë¶„ì„ê°€ê°€ ëŒ€í™” ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ íŒ€ì˜ ì†Œí†µ íŒ¨í„´ê³¼ ì‹œìŠ¤í…œ ë¦¬ìŠ¤í¬ë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤.",
        "uploader_label": "ë¶„ì„í•  ëŒ€í™” íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. (ì¹´ì¹´ì˜¤í†¡/whatsapp .txt íŒŒì¼ ê¶Œì¥)",
        "button_label": "ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„±í•˜ê¸°",
        "spinner_text": "AIê°€ ëŒ€í™” ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.",
        "toast_long_text": "ëŒ€í™” ë‚´ìš©ì´ ë„ˆë¬´ ê¸¸ì–´ ìµœì‹  3000ì¤„ë§Œ ë¶„ì„í•©ë‹ˆë‹¤.",
        "success_message": "âœ… AI ì¡°ì§ ì§„ë‹¨ ë¦¬í¬íŠ¸ê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.",
        "error_report_failed": "ë¦¬í¬íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ ë‚´ìš©ì´ ë„ˆë¬´ ì§§ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ í˜•ì‹ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        "error_generic": "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}",
        "warning_no_file": "ë¶„ì„ì„ ìœ„í•´ ë¨¼ì € ëŒ€í™” íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”."
    },
    "en": {
        "page_title": "MirrorOrg Diagnostics",
        "lang_selector_label": "Language / ì–¸ì–´",
        "sidebar_info_header": "ğŸ’¡ **How to Use**",
        "sidebar_info_text": "1. Upload your team's chat log (e.g., KakaoTalk/whatsapp .txt file).\n2. Click the 'Generate Analysis Report' button.\n3. Receive a 1-page diagnostic report generated by AI.",
        "sidebar_warn_header": "âš ï¸ **Disclaimer**",
        "sidebar_warn_text": "This is a technology demonstrator. The analysis is for reference only and should not be used for personnel evaluation. All uploaded data is processed in memory and not stored.",
        "sidebar_copyright": "Â© 2025 Sunghwan Oh. All Rights Reserved.",
        "main_title": "ğŸ§  MirrorOrg Diagnostic Report",
        "main_subtitle": "An AI organizational psychologist diagnoses team communication patterns and systemic risks based on your chat history.",
        "uploader_label": "Upload a chat file to analyze. (KakaoTalk/whatsapp .txt recommended)",
        "button_label": "Generate Analysis Report",
        "spinner_text": "The AI is analyzing the conversation to generate a report... Please wait.",
        "toast_long_text": "The chat history is too long. Analyzing the latest 3000 lines.",
        "success_message": "âœ… The AI diagnostic report is complete.",
        "error_report_failed": "Failed to generate the report. The file content might be too short or in an invalid format.",
        "error_generic": "An error occurred: {e}",
        "warning_no_file": "Please upload a chat file first to begin analysis."
    }
}

# --- UI ì„¤ì • (í˜ì´ì§€ ë° ì‚¬ì´ë“œë°”) ---
# ì–¸ì–´ ì„ íƒì— ë”°ë¼ í˜ì´ì§€ ì œëª©ì„ ë™ì ìœ¼ë¡œ ì„¤ì •
lang_selection = st.sidebar.radio(
    label="Language / ì–¸ì–´", 
    options=["í•œêµ­ì–´", "English"], 
    key="lang_selector"
)
lang_code = "ko" if lang_selection == "í•œêµ­ì–´" else "en"
T = TRANSLATIONS[lang_code] # ì„ íƒëœ ì–¸ì–´ì˜ í…ìŠ¤íŠ¸ ë”•ì…”ë„ˆë¦¬

st.set_page_config(page_title=T["page_title"], layout="centered")

# ì‚¬ì´ë“œë°” êµ¬ì„±
with st.sidebar:
    st.info(f"#### {T['sidebar_info_header']}\n{T['sidebar_info_text']}")
    st.warning(f"#### {T['sidebar_warn_header']}\n{T['sidebar_warn_text']}")
    st.markdown("---")
    st.markdown(T["sidebar_copyright"])

# --- ë©”ì¸ í™”ë©´ êµ¬ì„± ---
st.title(T["main_title"])
st.markdown(T["main_subtitle"])

uploaded_file = st.file_uploader(
    T["uploader_label"], 
    type="txt"
)

analyze_button = st.button(T["button_label"], type="primary")

# --- ë¶„ì„ ë¡œì§ ì‹¤í–‰ ---
if analyze_button and uploaded_file:
    with st.spinner(T["spinner_text"]):
        try:
            chat_content = uploaded_file.read().decode("utf-8")
            
            lines = chat_content.split('\n')
            if len(lines) > 3000:
                chat_content = '\n'.join(lines[-3000:])
                st.toast(T["toast_long_text"])

            # ë¶„ì„ ëª¨ë“ˆ í˜¸ì¶œ ì‹œ, ì„ íƒëœ ì–¸ì–´ ì½”ë“œ(lang_code)ë¥¼ ì „ë‹¬
            report = analyze_report(chat_content, lang=lang_code)

            if report:
                st.markdown("---")
                st.success(T["success_message"])
                st.markdown(report)
            else:
                st.error(T["error_report_failed"])

        except Exception as e:
            st.error(T["error_generic"].format(e=e))

elif analyze_button and not uploaded_file:
    st.warning(T["warning_no_file"])
